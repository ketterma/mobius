---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../../../base/infrastructure/traefik
  - cloudflare-secret.sops.yaml

patches:
  # PHX cluster Traefik configuration with MetalLB LoadBalancer
  - patch: |-
      apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      metadata:
        name: traefik
        namespace: flux-system
      spec:
        values:
          # Standard deployment (no hostNetwork)
          deployment:
            kind: Deployment
            replicas: 1

          # LoadBalancer service - MetalLB will assign VPS public IP
          service:
            type: LoadBalancer
            spec:
              externalTrafficPolicy: Local  # Preserve client source IPs

          # Standard container ports (MetalLB handles external mapping)
          ports:
            web:
              port: 8000
              expose:
                default: true
              exposedPort: 80
            websecure:
              port: 8443
              expose:
                default: true
              exposedPort: 443
              http3:
                enabled: true
              tls:
                enabled: true

          # Persistent storage for Let's Encrypt certificates
          persistence:
            enabled: true
            storageClass: local-path
            size: 1Gi
            path: /data

          # Let's Encrypt DNS-01 challenge with Cloudflare
          additionalArguments:
            - "--certificatesresolvers.letsencrypt.acme.email=admin@jaxon.cloud"
            - "--certificatesresolvers.letsencrypt.acme.storage=/data/acme.json"
            - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"
            - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
            - "--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"

          # Cloudflare API token for DNS-01 challenge
          env:
            - name: CF_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: cloudflare-api-token
                  key: CF_API_TOKEN
    target:
      kind: HelmRelease
      name: traefik
