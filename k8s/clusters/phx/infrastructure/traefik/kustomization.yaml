---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../../../base/infrastructure/traefik

patches:
  # PHX cluster Traefik configuration with hostNetwork
  - patch: |-
      apiVersion: helm.toolkit.fluxcd.io/v2
      kind: HelmRelease
      metadata:
        name: traefik
        namespace: flux-system
      spec:
        values:
          # Use host network - Traefik binds directly to node's port 80/443
          deployment:
            kind: Deployment
            replicas: 1

          # Enable hostNetwork
          hostNetwork: true

          # DNS policy for pods using hostNetwork
          dnsPolicy: ClusterFirstWithHostNet

          # ClusterIP service (not LoadBalancer or NodePort)
          service:
            type: ClusterIP

          # Configure ports for hostNetwork mode
          ports:
            # Dashboard on port 9000 to avoid kube-router conflict on 8080
            traefik:
              port: 9000
              expose:
                default: true
              exposedPort: 9000
            # HTTP on port 80 (direct binding with hostNetwork)
            web:
              port: 80
              expose:
                default: true
              exposedPort: 80
            # HTTPS on port 443 (direct binding with hostNetwork)
            websecure:
              port: 443
              expose:
                default: true
              exposedPort: 443
              http3:
                enabled: true
              tls:
                enabled: true

          # Persistent storage for Let's Encrypt certificates
          persistence:
            enabled: true
            storageClass: local-path
            size: 1Gi
            path: /data

          # Let's Encrypt HTTP-01 challenge (public IP accessible)
          additionalArguments:
            - "--certificatesresolvers.letsencrypt.acme.email=admin@jaxon.cloud"
            - "--certificatesresolvers.letsencrypt.acme.storage=/data/acme.json"
            - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
            - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    target:
      kind: HelmRelease
      name: traefik
