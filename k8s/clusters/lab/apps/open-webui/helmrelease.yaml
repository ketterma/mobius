---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: open-webui
  namespace: open-webui
spec:
  interval: 15m
  chart:
    spec:
      chart: open-webui
      version: '>=3.0.0 <4.0.0'
      sourceRef:
        kind: HelmRepository
        name: open-webui
        namespace: open-webui
      interval: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Open WebUI configuration
    image:
      repository: ghcr.io/open-webui/open-webui
      tag: main
      pullPolicy: IfNotPresent

    # Persistent storage for data, models, and uploads
    persistence:
      enabled: true
      size: 100Gi
      storageClass: openebs-zfs-homelab
      accessModes:
        - ReadWriteOnce

    # Service configuration
    service:
      type: ClusterIP
      port: 8080

    # Resources - adjust as needed
    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "2Gi"
        cpu: "2000m"

    # Connect to host Ollama instead of deploying in-cluster
    ollama:
      enabled: false

    # Point to host Ollama instance
    ollamaUrls:
      - http://192.168.4.5:11434

    # OAuth configuration for Pocket ID
    extraEnvVars:
      - name: OAUTH_CLIENT_ID
        value: "0b1028bf-aa91-432e-b88b-1ccc21ffa410"
      - name: OAUTH_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: open-webui-oauth
            key: OAUTH_CLIENT_SECRET
      - name: OPENID_PROVIDER_URL
        value: "http://pocket-id.pocket-id/.well-known/openid-configuration"
      - name: OAUTH_PROVIDER_NAME
        value: "Pocket ID"

    # Ingress disabled - we'll use Traefik IngressRoute instead
    ingress:
      enabled: false
