name: Deploy to Kubernetes

on:
  # Trigger after validation workflow completes successfully
  workflow_run:
    workflows: ["Kubernetes Manifest Validation"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  # Only run if validation succeeded
  check-validation:
    name: Check Validation Status
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - run: echo "Validation passed, proceeding with deployment"

  setup:
    name: Setup Tools
    runs-on: [self-hosted, phx]
    needs: check-validation
    steps:
      - name: Cache tools
        uses: actions/cache@v4
        with:
          path: ~/.local/bin
          key: tools-${{ runner.os }}-v2

      - name: Install tools
        run: |
          mkdir -p ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"

          # Install kubectl if not cached
          if [ ! -f ~/.local/bin/kubectl ]; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl ~/.local/bin/
          fi

          # Install helm if not cached
          if [ ! -f ~/.local/bin/helm ]; then
            curl -fsSL https://get.helm.sh/helm-v3.16.3-linux-amd64.tar.gz | tar xz
            mv linux-amd64/helm ~/.local/bin/
            rm -rf linux-amd64
          fi

          # Install sops if not cached
          if [ ! -f ~/.local/bin/sops ]; then
            curl -LO https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
            chmod +x sops-v3.9.0.linux.amd64
            mv sops-v3.9.0.linux.amd64 ~/.local/bin/sops
          fi

          # Add all Helm repos upfront
          helm repo add metallb https://metallb.github.io/metallb
          helm repo add traefik https://traefik.github.io/charts
          helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
          helm repo add uptime-kuma https://dirsigler.github.io/uptime-kuma-helm
          helm repo update

  # Lab cluster Helm deployments
  lab-metallb:
    name: "Lab: MetalLB"
    runs-on: [self-hosted, phx]
    needs: setup
    environment:
      name: lab
      url: https://192.168.8.50
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-lab
          helm upgrade --install metallb-system-metallb metallb/metallb \
            --namespace metallb-system \
            --create-namespace \
            --values k8s/clusters/lab/infrastructure/metallb/values.yaml \
            --wait

  lab-traefik:
    name: "Lab: Traefik"
    runs-on: [self-hosted, phx]
    needs: setup
    environment:
      name: lab
      url: https://192.168.8.50
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-lab
          helm upgrade --install traefik-traefik traefik/traefik \
            --namespace traefik \
            --create-namespace \
            --values k8s/clusters/lab/infrastructure/traefik/values.yaml \
            --wait

  lab-external-dns:
    name: "Lab: External-DNS"
    runs-on: [self-hosted, phx]
    needs: setup
    environment:
      name: lab
      url: https://192.168.8.50
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-lab
          helm upgrade --install external-dns external-dns/external-dns \
            --namespace external-dns \
            --create-namespace \
            --values k8s/clusters/lab/infrastructure/external-dns/values.yaml \
            --wait

  lab-infrastructure-config:
    name: "Lab: Infrastructure Config"
    runs-on: [self-hosted, phx]
    needs: [setup, lab-metallb, lab-traefik]
    environment:
      name: lab
      url: https://192.168.8.50
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-lab
          export SOPS_AGE_KEY_FILE=/home/runner/.age/key.txt
          find k8s/clusters/lab -name "*.sops.yaml" -exec sops -d -i {} \;
          kubectl apply -k k8s/clusters/lab/infrastructure-config

  lab-apps:
    name: "Lab: Apps"
    runs-on: [self-hosted, phx]
    needs: [setup, lab-traefik]
    environment:
      name: lab
      url: https://192.168.8.50
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-lab
          export SOPS_AGE_KEY_FILE=/home/runner/.age/key.txt
          find k8s/clusters/lab -name "*.sops.yaml" -exec sops -d -i {} \;
          kubectl apply -k k8s/clusters/lab/apps

  # PHX cluster Helm deployments
  phx-traefik:
    name: "PHX: Traefik"
    runs-on: [self-hosted, phx]
    needs: setup
    environment:
      name: phx
      url: https://uptime.jaxon.cloud
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-phx
          helm upgrade --install traefik-traefik traefik/traefik \
            --namespace traefik \
            --create-namespace \
            --values k8s/clusters/phx/infrastructure/traefik/values.yaml \
            --wait

  phx-external-dns:
    name: "PHX: External-DNS"
    runs-on: [self-hosted, phx]
    needs: setup
    environment:
      name: phx
      url: https://uptime.jaxon.cloud
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-phx
          helm upgrade --install external-dns external-dns/external-dns \
            --namespace external-dns \
            --create-namespace \
            --values k8s/clusters/phx/infrastructure/external-dns/values.yaml \
            --wait

  phx-uptime-kuma:
    name: "PHX: Uptime Kuma"
    runs-on: [self-hosted, phx]
    needs: setup
    environment:
      name: phx
      url: https://uptime.jaxon.cloud
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-phx
          helm upgrade --install uptime-kuma uptime-kuma/uptime-kuma \
            --namespace uptime-kuma \
            --create-namespace \
            --values k8s/clusters/phx/apps/uptime-kuma/values.yaml \
            --wait

  phx-infrastructure-config:
    name: "PHX: Infrastructure Config"
    runs-on: [self-hosted, phx]
    needs: [setup, phx-traefik]
    environment:
      name: phx
      url: https://uptime.jaxon.cloud
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-phx
          export SOPS_AGE_KEY_FILE=/home/runner/.age/key.txt
          find k8s/clusters/phx -name "*.sops.yaml" -exec sops -d -i {} \;
          kubectl apply -k k8s/clusters/phx/infrastructure-config

  phx-apps:
    name: "PHX: Apps"
    runs-on: [self-hosted, phx]
    needs: [setup, phx-traefik]
    environment:
      name: phx
      url: https://uptime.jaxon.cloud
    steps:
      - uses: actions/checkout@v4
      - run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-phx
          export SOPS_AGE_KEY_FILE=/home/runner/.age/key.txt
          find k8s/clusters/phx -name "*.sops.yaml" -exec sops -d -i {} \;
          kubectl apply -k k8s/clusters/phx/apps

  notify:
    name: Send Notification
    runs-on: [self-hosted, phx]
    needs:
      - lab-metallb
      - lab-traefik
      - lab-external-dns
      - lab-infrastructure-config
      - lab-apps
      - phx-traefik
      - phx-external-dns
      - phx-uptime-kuma
      - phx-infrastructure-config
      - phx-apps
    if: always()
    steps:
      - name: Notify via Pushover
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Count successes and failures
          TOTAL=10
          SUCCESS=0
          FAILED=0

          for result in \
            "${{ needs.lab-metallb.result }}" \
            "${{ needs.lab-traefik.result }}" \
            "${{ needs.lab-external-dns.result }}" \
            "${{ needs.lab-infrastructure-config.result }}" \
            "${{ needs.lab-apps.result }}" \
            "${{ needs.phx-traefik.result }}" \
            "${{ needs.phx-external-dns.result }}" \
            "${{ needs.phx-uptime-kuma.result }}" \
            "${{ needs.phx-infrastructure-config.result }}" \
            "${{ needs.phx-apps.result }}"
          do
            if [ "$result" = "success" ]; then
              SUCCESS=$((SUCCESS + 1))
            else
              FAILED=$((FAILED + 1))
            fi
          done

          if [ $FAILED -eq 0 ]; then
            TITLE="✅ Deploy Succeeded"
            MESSAGE="All deployments successful ($SUCCESS/$TOTAL)"
            PRIORITY=0
          else
            TITLE="❌ Deploy Failed"
            MESSAGE="$SUCCESS/$TOTAL succeeded, $FAILED failed"
            PRIORITY=1
          fi

          curl -s -X POST https://api.pushover.net/1/messages.json \
            -d "token=${{ secrets.PUSHOVER_TOKEN }}" \
            -d "user=${{ secrets.PUSHOVER_USER }}" \
            -d "title=$TITLE" \
            -d "message=$MESSAGE" \
            -d "url=$RUN_URL" \
            -d "url_title=View Run" \
            -d "priority=$PRIORITY"
