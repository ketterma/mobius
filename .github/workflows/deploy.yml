name: Deploy to Kubernetes

on:
  push:
    branches: [main]
    paths:
      - 'k8s/**'
  workflow_dispatch:

jobs:
  deploy-lab:
    name: Deploy to Lab Cluster
    runs-on: [self-hosted, phx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache tools
        uses: actions/cache@v4
        with:
          path: ~/.local/bin
          key: tools-${{ runner.os }}-v1

      - name: Install tools
        run: |
          mkdir -p ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"

          # Install kubectl if not cached
          if [ ! -f ~/.local/bin/kubectl ]; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl ~/.local/bin/
          fi

          # Install sops if not cached
          if [ ! -f ~/.local/bin/sops ]; then
            curl -LO https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
            chmod +x sops-v3.9.0.linux.amd64
            mv sops-v3.9.0.linux.amd64 ~/.local/bin/sops
          fi

      - name: Deploy to Lab
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-lab
          export SOPS_AGE_KEY_FILE=/home/runner/.age/key.txt

          # Decrypt all SOPS files in-place
          find k8s/clusters/lab -name "*.sops.yaml" -exec sops -d -i {} \;

          kubectl apply -k k8s/clusters/lab/infrastructure-config
          kubectl apply -k k8s/clusters/lab/apps

  deploy-phx:
    name: Deploy to PHX Cluster
    runs-on: [self-hosted, phx]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache tools
        uses: actions/cache@v4
        with:
          path: ~/.local/bin
          key: tools-${{ runner.os }}-v1

      - name: Install tools
        run: |
          mkdir -p ~/.local/bin
          export PATH="$HOME/.local/bin:$PATH"

          # Install kubectl if not cached
          if [ ! -f ~/.local/bin/kubectl ]; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl ~/.local/bin/
          fi

          # Install sops if not cached
          if [ ! -f ~/.local/bin/sops ]; then
            curl -LO https://github.com/getsops/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64
            chmod +x sops-v3.9.0.linux.amd64
            mv sops-v3.9.0.linux.amd64 ~/.local/bin/sops
          fi

      - name: Deploy to PHX
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export KUBECONFIG=/home/runner/.kube/config-phx
          export SOPS_AGE_KEY_FILE=/home/runner/.age/key.txt

          # Decrypt all SOPS files in-place
          find k8s/clusters/phx -name "*.sops.yaml" -exec sops -d -i {} \;

          kubectl apply -k k8s/clusters/phx/infrastructure
          kubectl apply -k k8s/clusters/phx/infrastructure-config

  notify:
    name: Send Notification
    runs-on: [self-hosted, phx]
    needs: [deploy-lab, deploy-phx]
    if: always()
    steps:
      - name: Notify via Pushover
        run: |
          LAB_RESULT="${{ needs.deploy-lab.result }}"
          PHX_RESULT="${{ needs.deploy-phx.result }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$LAB_RESULT" = "success" ] && [ "$PHX_RESULT" = "success" ]; then
            TITLE="✅ Deploy Succeeded"
            MESSAGE="Lab ✓ PHX ✓"
            PRIORITY=0
          else
            TITLE="❌ Deploy Failed"
            # Build detailed failure message
            MSG=""
            [ "$LAB_RESULT" != "success" ] && MSG="Lab: $LAB_RESULT"
            [ "$PHX_RESULT" != "success" ] && MSG="$MSG${MSG:+, }PHX: $PHX_RESULT"
            MESSAGE="$MSG"
            PRIORITY=1
          fi

          curl -s -X POST https://api.pushover.net/1/messages.json \
            -d "token=${{ secrets.PUSHOVER_TOKEN }}" \
            -d "user=${{ secrets.PUSHOVER_USER }}" \
            -d "title=$TITLE" \
            -d "message=$MESSAGE" \
            -d "url=$RUN_URL" \
            -d "url_title=View Run" \
            -d "priority=$PRIORITY"
